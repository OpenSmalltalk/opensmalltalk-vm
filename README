The Cog VM source tree
---------------------
This is the README for the Cog subversion source tree:
	http://www.squeakvm.org/svn/squeak/branches/Cog

Contents:
	- Overview
	- VM source directories
	- Platform build directories
	- Other directories


Overview
--------

Cog is an evolution of the Squeak Back-to-the-future Smalltalk virtual machine
that provides a number of different Smalltalk virtual machines.  The VMs are
developed in Smalltalk, using all the dynamic and reflective facilities of the
Squeak/Pharo Smalltalk system.  As such, developing in Cog is a delight.  The
Smalltalk framework comprising the various Cog VMs is translated into C by its
Slang component to produce VM source that is combined with platform-specific
support soures and compiled via a C compiler to obtain a fast production VM.
This directory tree includes the output of Slang for various configurations of
"Cog VM" and the associated platform support code, plus build directories that
can be used to produce production VMs.

This directory tree also includes an instance of the Smalltalk Cog development
system, suitable for developing the VM in Smalltalk, and for generating new
VM sources.

The "Cog VM" comes in a bewildering variety of forms.  The first distinction
is between Squeak/Croquet VMs that run Squeak, Pharo, Cuis, Croquet images
and their ilk, and between Newspeak VMs that run Newspeak.

Another distinction is between Stack, Cog and Sista VMs.  Stack VMs are those
with context-to-stack mapping that optimise message sending by keeping method
activations on a stack instead of in contexts.  These are pure interpreters but
significantly faster than the standard context-based Interpreter VM.  Cog VMs
add a JIT to the mix, compiling methods used more than once to maxchine code on
the fly.  Sista VMs, as yet unrealised and in development, add support for
adaptive optimization that does speculative inlining at the bytecode-to-bytecode
level.  These are targeted for release in 2015.

Another distinction is between "v3" VMs and Spur VMs.  "v3" is the original
object representation for Squeak as described in the back-to-the-future paper.
Spur, as described on the www.mirandabanda.org blog, is a faster object
representation which uses generation scavenging, lazy forwarding for fast
become, and a single object header format common to 32 and 64 bit versions.

Another distinction is between normal single-threaded VMs that schedule "green"
Smalltalk processes above a single-threaded VM, and "multi-threaded" VMs that
share the VM between any number of native threads such that only one native
thread owns the VM at any one time, switching between threads on FFI calls and
callbacks or on Smalltalk process switches when Smalltalk processes are owned
by threads.  This multi-threaded support is as yet experimental.


VM source directories
---------------------

Slang output of various VMs are kept in "vm source" directories.  These sources
define the core VM (the Smalltalk execution engine and memory manager), and a
substantial set of "plugins" that provide interfaces to various external
facilities via Smalltalk primitive methods.  Each vm source directory is
specific to a particular VM, be it Squeak Cog Spur, or Newspeak Stack, etc.
The plugins can be shared between VMs, choosing the set of plugins to include
in a VM at build time.

The VM source are in directories such as
	nscogsrc/vm			- Newspeak Cog V3
	nsspursrc/vm		- Newspeak Cog Spur
	nsspurstacksrc/vm	- Newspeak Stack Spur
	nsstacksrc/vm		- Newspeak Stack V3
	sistasrc/vm			- Smalltalk Sista V3
	spursistasrc/vm		- Smalltalk Sista Spur
	spursrc/vm			- Smalltalk Cog Spur
	spurstacksrc/vm		- Smalltalk Stack Spur
	src/vm				- Smalltalk Cog V3
	stacksrc/vm			- Smalltalk Stack V3

There are two plugin directories
	nscogsrc/plugins
	src/plugins

These contain many, but not all, of the plugins available for the VM.  Others
can be found in Cog, or in various Monticello packages in various repositories.
The two directories include essentially the same material exept for the
IA32ABI/IA32ABI.c plugin, the core plugin for the Alien FFI on x86 platforms.
In Newspeak this plgin has support for per-object immutability, a feature
as-yet-unimplemented in Cog but that was available on the old context-based
Newspeak interpreter VM.


Platform build directories
--------------------------
Build directories are in flux.  Currently there exist some old build directories
such as unixbuild, cygwinbuild et al.  These are deprecated and will be removed
before the end of 2014.  The current "official" buikd directories are of the
form build.OS_WordSize_Processor, and include
	build.linux32x86	- uses autoconf, gcc and make
	build.macos32x86	- uses XCode and gcc (currently for 10.6 or earlier)
	build.win32x86		- uses cygwin, gcc and make
More can be added as required.  In each there is a HowToBuild that describes
the necessary steps to produce a VM.

In addition, there is a set of build directories that use the CMake build
configuration system.  These are not yet ready to describe as of this writing.

The scripts directory contains various scripts for validating and checking-in
generated sources, packaging builds into installable artifacts (tar, msi, zip),
and so on.  The linux builds and the packaging scripts produce outputs in the
products directory tree.  The packaging scripts may choose to include Smalltalk
source files included in the sources directory.


Other directories
-----------------
The platforms directory contains the associated platform-specific files that
combine with the Slang-generated source to produce complete VMs.  The structure
is
	platforms/Cross/vm
	platforms/Cross/plugins
	platforms/iOS/vm
	platforms/iOS/plugins
	platforms/Mac OS/vm
	platforms/Mac OS/plugins
	platforms/unix/vm*
	platforms/unix/plugins
	platforms/win32/vm
	platforms/win32/plugins

Each vm directory contains support for the core VM.  Each plugin directory
contains run-time and build-time support for various plugins.  The following
directories are external and shared with the Squeak trunk interpreter source:

	platforms/Cross/plugins
		- http://squeakvm.org/svn/squeak/trunk/platforms/Cross/plugins
	platforms/iOS
		- http://squeakvm.org/svn/squeak/trunk/platforms/iOS
	platforms/win32/plugins
		- http://squeakvm.org/svn/squeak/trunk/platforms/win32/plugins

The processors directory contains the source for various processor simulators.
The JIT is developed in Smalltalk by using one of these processor simulators
to execute the code the JIT produces.  Currently only the Bochs x86/x86-64
simulator and the gdbarm simulator are in use, for x86 and ARMv5 respectively.

Finally the image directory contains scripts that will build a "VMMaker" image,
a Squeak Smalltalk image containing all the packages that comprise the Cog
system, suitable for developing the VM and for generating (or updating) the
sources in the vm source directories.

Eliot Miranda
June 2014
